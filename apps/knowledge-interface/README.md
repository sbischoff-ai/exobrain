# Exobrain Knowledge Interface

Rust + tonic gRPC service for GraphRAG ingestion and canonical KG schema registry access.

## What this service is

- Provides schema introspection (`GetSchema`) and schema type upsert (`UpsertSchemaType`).
- Accepts schema-driven graph writes through `UpsertGraphDelta`.
- Exposes `InitializeUserGraph` to seed a new user-scoped starter subgraph.
- Uses typed property payloads instead of hardcoded event/task fields.

## Quick start

Use shared startup docs for infra and multi-service runs:

- [`../../docs/development/local-setup.md`](../../docs/development/local-setup.md)
- [`../../docs/development/process-orchestration.md`](../../docs/development/process-orchestration.md)

Service-only build/run:

```bash
./scripts/local/build-knowledge-interface.sh
./scripts/local/run-knowledge-interface.sh
```

## Common commands

```bash
./scripts/local/knowledge-schema-migrate.sh
./scripts/local/knowledge-schema-seed.sh
./scripts/local/knowledge-schema-reset-and-seed.sh
./scripts/local/knowledge-graph-reset.sh
```

`knowledge-graph-reset.sh` now restores graph services only if they were running before reset; if infra was down, it stays down.

Inspect gRPC APIs locally:

```bash
grpcui -plaintext localhost:50051
```

## Configuration

- Copy env template: `cp apps/knowledge-interface/.env.example apps/knowledge-interface/.env`
- `APP_ENV=local` enables local gRPC reflection.
- `LOG_LEVEL` defaults to `DEBUG` for local and `INFO` otherwise.
- `MEMGRAPH_DB` defaults to `memgraph`; set it explicitly if your Memgraph uses a different database name.
- If `EMBEDDING_USE_MOCK=true`, embeddings are generated by a deterministic mock embedder for offline/agent development.
- Otherwise embeddings are routed through model-provider via `MODEL_PROVIDER_BASE_URL` and alias `MODEL_PROVIDER_EMBEDDING_ALIAS` (default `all-purpose`).

## Built-in graph bootstrapping

On startup, the service checks whether the shared root graph exists in Memgraph and seeds it if missing. The seed is written through the same validated ingestion pipeline used by gRPC requests, including Qdrant projection updates.

## Write consistency guarantees

All graph writes now flow through a single application path (`KnowledgeApplication::upsert_graph_delta`) that:

1. Validates the delta against schema type/property/rule contracts.
2. Generates embeddings for `node.block` nodes.
3. Writes to Memgraph and Qdrant as one coordinated operation.

The Memgraph write is held in a transaction until Qdrant upserts complete. If Qdrant fails, Memgraph is rolled back. If Memgraph commit fails after Qdrant upsert, the new Qdrant points are deleted as compensation.

## InitializeUserGraph gRPC

`InitializeUserGraph` accepts `user_id` + `user_name` and creates a shared starter subgraph for that user:

- person entity (UUID id) with aliases `me`, `I`, `myself`
- object entity (UUID id) named `Exobrain Assistant`
- one descriptive assistant block (embedded + upserted to Qdrant)
- `RELATED_TO` edge from assistant -> person

## Graph delta constraints for clients

See detailed contract docs here:

- [`./docs/grpc-api.md`](./docs/grpc-api.md)
- [`../../docs/knowledge/graph-schema.md`](../../docs/knowledge/graph-schema.md)

## Local UIs

- Memgraph Lab (via local compose): `http://localhost:13000`
- Qdrant dashboard: `http://localhost:16333/dashboard`

## Related docs

- Service notes: [`./docs/implementation.md`](./docs/implementation.md)
- Graph schema reference: [`../../docs/knowledge/graph-schema.md`](../../docs/knowledge/graph-schema.md)
- Docs hub: [`../../docs/README.md`](../../docs/README.md)
